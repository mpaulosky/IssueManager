name: Build and Test

permissions:
  issues: write
  checks: write
  contents: read
  pull-requests: write

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "**"
      - "!main"

  workflow_dispatch:
    inputs:
      reason:
        description: "The reason for running the workflow"
        required: true
        default: "Manual run"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  versioning:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.gitversion.outputs.fullSemVer }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4
        with:
          versionSpec: "6.3.0"

      - name: Use GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4

      - name: Display GitVersion
        run: |
          echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
          echo "MajorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}"

  test-suite:
    name: Run Test Suite
    needs: versioning
    uses: ./.github/workflows/squad-test.yml@main

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: test-suite
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate notification
        run: |
          echo "## CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.versioning.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-suite.result }}" == "success" ]; then
            echo "### ✅ Test Suite Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Test Suite Failed" >> $GITHUB_STEP_SUMMARY
          fi
