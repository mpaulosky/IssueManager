name: Test Suite

permissions:
  issues: write
  checks: write
  contents: read
  pull-requests: write

on:
  workflow_call:
  push:
    branches:
      - main
      - "squad/*"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      reason:
        description: "The reason for running the workflow"
        required: true
        default: "Manual test run"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build Solution
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build IssueManager.sln --configuration Release --no-restore

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build IssueManager.sln --configuration Release --no-restore

      - name: Run Unit Tests
        id: unit-tests
        run: |
          mkdir -p test-results coverage-reports
          if [ ! -d "tests/Unit" ]; then
            echo "::error::Unit test project not found at tests/Unit"
            exit 1
          fi
          dotnet test tests/Unit \
            --configuration Release \
            --no-build \
            --no-restore \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=unit.trx" \
            --results-directory test-results \
            --verbosity minimal
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "::error::Unit tests failed"
          fi
          exit $exit_code

      - name: Upload Unit Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: unit-test-results
          path: test-results

  test-architecture:
    name: Architecture Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build IssueManager.sln --configuration Release --no-restore

      - name: Run Architecture Tests
        id: arch-tests
        run: |
          mkdir -p test-results
          if [ ! -d "tests/Architecture" ]; then
            echo "::error::Architecture test project not found at tests/Architecture"
            exit 1
          fi
          dotnet test tests/Architecture \
            --configuration Release \
            --no-build \
            --no-restore \
            --logger "trx;LogFileName=architecture.trx" \
            --results-directory test-results \
            --verbosity minimal
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "::error::Architecture tests failed"
          fi
          exit $exit_code

      - name: Upload Architecture Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: architecture-test-results
          path: test-results

  test-bunit:
    name: Blazor Component Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build IssueManager.sln --configuration Release --no-restore

      - name: Run bUnit Tests
        id: bunit-tests
        run: |
          mkdir -p test-results coverage-reports
          if [ ! -d "tests/BlazorTests" ]; then
            echo "::error::Blazor test project not found at tests/BlazorTests"
            exit 1
          fi
          dotnet test tests/BlazorTests \
            --configuration Release \
            --no-build \
            --no-restore \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=bunit.trx" \
            --results-directory test-results \
            --verbosity minimal
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "::error::Blazor component tests failed"
          fi
          exit $exit_code

      - name: Upload bUnit Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: bunit-test-results
          path: test-results

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      MONGODB_CONNECTION_STRING: "mongodb://localhost:27017/issuemanager-test"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build IssueManager.sln --configuration Release --no-restore

      - name: Run Integration Tests
        id: integration-tests
        run: |
          mkdir -p test-results coverage-reports
          if [ ! -d "tests/Integration" ]; then
            echo "::error::Integration test project not found at tests/Integration"
            exit 1
          fi
          dotnet test tests/Integration \
            --configuration Release \
            --no-build \
            --no-restore \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=integration.trx" \
            --results-directory test-results \
            --verbosity minimal
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "::error::Integration tests failed"
          fi
          exit $exit_code

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: integration-test-results
          path: test-results

  test-aspire:
    name: Aspire Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build IssueManager.sln --configuration Release --no-restore

      - name: Run Aspire Tests
        id: aspire-tests
        run: |
          mkdir -p test-results coverage-reports
          if [ ! -d "tests/Aspire" ]; then
            echo "::error::Aspire test project not found at tests/Aspire"
            exit 1
          fi
          dotnet test tests/Aspire \
            --configuration Release \
            --no-build \
            --no-restore \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=aspire.trx" \
            --results-directory test-results \
            --verbosity minimal
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "::error::Aspire tests failed"
          fi
          exit $exit_code

      - name: Upload Aspire Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: aspire-test-results
          path: test-results

  coverage:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - test-unit
      - test-bunit
      - test-integration
      - test-aspire
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Download coverage reports
        uses: actions/download-artifact@v6
        with:
          path: coverage-reports

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"coverage-reports/**/**/coverage.cobertura.xml" \
            -targetdir:"./coverage-output" \
            -reporttypes:"Html;Cobertura;JsonSummary" \
            -verbosity:verbose || echo "::warning::No coverage files found"

      - name: Check coverage threshold
        run: |
          if [ -f "./coverage-output/Summary.json" ]; then
            coverage=$(jq -r '.lineCoverage' ./coverage-output/Summary.json 2>/dev/null || echo "0")
            echo "Line Coverage: $coverage%"
            if (( $(echo "$coverage < 80" | bc -l) )); then
              echo "::warning::Code coverage is below 80% threshold: $coverage%"
            fi
          else
            echo "::notice::Coverage report not available"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-reports
          path: coverage-output

      - name: Publish to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          fail_ci_if_error: false
          files: ./coverage-output/Cobertura.xml
          verbose: false

  report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - build
      - test-unit
      - test-architecture
      - test-bunit
      - test-integration
      - test-aspire
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all test results
        uses: actions/download-artifact@v6
        with:
          path: all-test-results

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2.22.0
        if: always()
        with:
          files: all-test-results/**/*.trx
          check_name: Test Results Summary
          compare_to_earlier_commit: true

      - name: Generate job summary
        if: always()
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests:** ${{ needs.test-unit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture Tests:** ${{ needs.test-architecture.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Blazor Tests:** ${{ needs.test-bunit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests:** ${{ needs.test-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Aspire Tests:** ${{ needs.test-aspire.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Test results and coverage reports available in Actions artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage report: \`coverage-reports\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Set overall status
          build_status="${{ needs.build.result }}"
          unit_status="${{ needs.test-unit.result }}"
          arch_status="${{ needs.test-architecture.result }}"
          bunit_status="${{ needs.test-bunit.result }}"
          integration_status="${{ needs.test-integration.result }}"
          aspire_status="${{ needs.test-aspire.result }}"
          
          if [[ "$build_status" == "failure" || "$unit_status" == "failure" || "$arch_status" == "failure" || \
                "$bunit_status" == "failure" || "$integration_status" == "failure" || \
                "$aspire_status" == "failure" ]]; then
            echo "❌ **Overall Status:** FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Overall Status:** PASSED" >> $GITHUB_STEP_SUMMARY
          fi
